# ğŸš€ Vector Recall System

åŸºäº PyTorch å’Œ HNSW çš„é«˜æ€§èƒ½çŸ¢é‡å¬å›ç³»ç»Ÿï¼Œä¸“ä¸ºå¤§è§„æ¨¡æ¨èåœºæ™¯è®¾è®¡ã€‚

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![PyTorch](https://img.shields.io/badge/PyTorch-2.0+-red.svg)](https://pytorch.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

---

## ğŸ“– é¡¹ç›®è¯´æ˜

### èƒŒæ™¯

æ¨èç³»ç»Ÿéœ€è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**å¦‚ä½•ä¸ºæ—¢å®šç”¨æˆ·ç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸º K çš„æ¨èåˆ—è¡¨ï¼Œå¹¶ä½¿è¯¥æ¨èåˆ—è¡¨å°½é‡ï¼ˆé«˜å‡†ç¡®æ€§ï¼‰ã€å°½å¿«ï¼ˆä½å»¶è¿Ÿï¼‰åœ°æ»¡è¶³ç”¨æˆ·çš„å…´è¶£å’Œéœ€æ±‚ï¼Ÿ**

å¸¸è§„æ¨èç³»ç»Ÿé‡‡ç”¨ **ä¸¤é˜¶æ®µæ¶æ„**ï¼š

1. **çŸ¢é‡å¬å›ï¼ˆVector Recallï¼‰**ï¼šä»ç™¾ä¸‡çº§å€™é€‰æ± ä¸­å¿«é€Ÿç­›é€‰å‡ºæ•°ç™¾/æ•°åƒæ¡å€™é€‰å†…å®¹
2. **ç²¾æ’ï¼ˆRankingï¼‰**ï¼šå¯¹å¬å›ç»“æœè¿›è¡Œç²¾ç»†æ’åºï¼Œç”Ÿæˆæœ€ç»ˆæ¨èåˆ—è¡¨

æœ¬é¡¹ç›®ä¸“æ³¨äºç¬¬ä¸€é˜¶æ®µ â€”â€” **çŸ¢é‡å¬å›**ï¼Œå°†å…¶è½¬æ¢ä¸ºé«˜ç»´å‘é‡ç›¸ä¼¼æ€§æœç´¢é—®é¢˜ã€‚

### æ ¸å¿ƒæŠ€æœ¯

| æŠ€æœ¯ | è¯´æ˜ |
|------|------|
| **åŒå¡”æ¨¡å‹** | User Tower + Item Towerï¼Œåˆ†åˆ«ç¼–ç ç”¨æˆ·å’Œç‰©å“åˆ°ç»Ÿä¸€å‘é‡ç©ºé—´ |
| **å¯¹æ¯”å­¦ä¹ ** | ä½¿ç”¨ InfoNCE Loss è®­ç»ƒï¼Œæœ€å¤§åŒ–æ­£æ ·æœ¬ç›¸ä¼¼åº¦ |
| **HNSW ç´¢å¼•** | Hierarchical Navigable Small World å›¾ç´¢å¼•ï¼Œå®ç°æ¯«ç§’çº§ ANN æœç´¢ |

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¬å›å»¶è¿Ÿï¼ˆTop-500ï¼‰ | **< 2ms** |
| å•æœº QPS | **5000+** |
| ç´¢å¼•è§„æ¨¡ | **ç™¾ä¸‡çº§å‘é‡** |
| å¬å›ç²¾åº¦ | **Recall@500 > 95%** |

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Vector Recall System                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Training Phase (Offline)                        â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚   â”‚   User      â”‚              â”‚    Item     â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚  Features   â”‚              â”‚  Features   â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚  â€¢ user_id  â”‚              â”‚  â€¢ item_id  â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚  â€¢ profile  â”‚              â”‚  â€¢ category â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚  â€¢ behavior â”‚              â”‚  â€¢ tags     â”‚                         â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â”‚
â”‚  â”‚          â”‚                            â”‚                                 â”‚ â”‚
â”‚  â”‚          â–¼                            â–¼                                 â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚   â”‚    User     â”‚              â”‚    Item     â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚   Encoder   â”‚              â”‚   Encoder   â”‚    Two-Tower Model      â”‚ â”‚
â”‚  â”‚   â”‚  (Tower 1)  â”‚              â”‚  (Tower 2)  â”‚    (PyTorch)            â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â”‚
â”‚  â”‚          â”‚                            â”‚                                 â”‚ â”‚
â”‚  â”‚          â–¼                            â–¼                                 â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚   â”‚    User     â”‚              â”‚    Item     â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚  Embedding  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Embedding  â”‚                         â”‚ â”‚
â”‚  â”‚   â”‚   (128-D)   â”‚   Contrastiveâ”‚   (128-D)   â”‚                         â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    Learning  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â”‚
â”‚  â”‚                                       â”‚                                 â”‚ â”‚
â”‚  â”‚                                       â–¼                                 â”‚ â”‚
â”‚  â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚ â”‚
â”‚  â”‚                         â”‚    HNSW Index Builder   â”‚                    â”‚ â”‚
â”‚  â”‚                         â”‚   (Batch Encoding)      â”‚                    â”‚ â”‚
â”‚  â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ â”‚
â”‚  â”‚                                      â”‚                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚                                    â”‚
â”‚                                         â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Serving Phase (Online)                          â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚   â”‚   User       â”‚     â”‚    User      â”‚     â”‚      HNSW Index        â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   Request    â”‚â”€â”€â”€â”€â–ºâ”‚   Encoder    â”‚â”€â”€â”€â”€â–ºâ”‚  (Million Vectors)     â”‚ â”‚ â”‚
â”‚  â”‚   â”‚              â”‚     â”‚              â”‚     â”‚                        â”‚ â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                         â”‚              â”‚ â”‚
â”‚  â”‚                                                         â–¼              â”‚ â”‚
â”‚  â”‚                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚                                             â”‚   Top-K Candidates     â”‚ â”‚ â”‚
â”‚  â”‚                                             â”‚   (ANN Search ~1ms)    â”‚ â”‚ â”‚
â”‚  â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Two-Tower Model                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          User Tower               â”‚            Item Tower                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                   â”‚                                       â”‚
â”‚  Input:                           â”‚  Input:                               â”‚
â”‚  â€¢ user_id â”€â”€â–º Embedding(64)      â”‚  â€¢ item_id â”€â”€â–º Embedding(64)         â”‚
â”‚  â€¢ features â”€â–º Linear(64)         â”‚  â€¢ category â”€â–º Embedding(32)         â”‚
â”‚  â€¢ behavior â”€â–º Encoder(64)        â”‚  â€¢ tags â”€â”€â”€â”€â”€â–º Embedding(32) + Pool  â”‚
â”‚                                   â”‚  â€¢ features â”€â–º Linear(64)             â”‚
â”‚         â”‚                         â”‚         â”‚                             â”‚
â”‚         â–¼                         â”‚         â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   Concat    â”‚ (192-D)          â”‚  â”‚   Concat    â”‚ (192-D)              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                         â”‚         â”‚                             â”‚
â”‚         â–¼                         â”‚         â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  MLP Block  â”‚ 192â†’256          â”‚  â”‚  MLP Block  â”‚ 192â†’256              â”‚
â”‚  â”‚  BN + ReLU  â”‚                  â”‚  â”‚  BN + ReLU  â”‚                      â”‚
â”‚  â”‚  Dropout    â”‚                  â”‚  â”‚  Dropout    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                         â”‚         â”‚                             â”‚
â”‚         â–¼                         â”‚         â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  MLP Block  â”‚ 256â†’128          â”‚  â”‚  MLP Block  â”‚ 256â†’128              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                         â”‚         â”‚                             â”‚
â”‚         â–¼                         â”‚         â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   Linear    â”‚ 128â†’128          â”‚  â”‚   Linear    â”‚ 128â†’128              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                         â”‚         â”‚                             â”‚
â”‚         â–¼                         â”‚         â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ L2 Normalizeâ”‚                  â”‚  â”‚ L2 Normalizeâ”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                         â”‚         â”‚                             â”‚
â”‚         â–¼                         â”‚         â–¼                             â”‚
â”‚   User Vector (128-D)             â”‚   Item Vector (128-D)                 â”‚
â”‚                                   â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Cosine Similarity   â”‚
                    â”‚   InfoNCE Loss        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HNSW ç´¢å¼•åŸç†

```
HNSW (Hierarchical Navigable Small World)
==========================================

Layer 2:  â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹  (å°‘é‡èŠ‚ç‚¹ï¼Œé•¿è·ç¦»è¿æ¥)
          â”‚                   â”‚
          â”‚                   â”‚
Layer 1:  â—‹â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â—‹  (ä¸­ç­‰èŠ‚ç‚¹æ•°)
          â”‚     â”‚     â”‚       â”‚     â”‚
          â”‚     â”‚     â”‚       â”‚     â”‚
Layer 0:  â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹â”€â—‹  (æ‰€æœ‰èŠ‚ç‚¹ï¼ŒçŸ­è·ç¦»è¿æ¥)

æœç´¢è¿‡ç¨‹:
1. ä»æœ€é«˜å±‚çš„å…¥å£ç‚¹å¼€å§‹
2. åœ¨å½“å‰å±‚è´ªå©ªæœç´¢æœ€è¿‘é‚»
3. å½“æ— æ³•æ›´æ¥è¿‘æ—¶ï¼Œä¸‹é™åˆ°ä¸‹ä¸€å±‚
4. åœ¨æœ€åº•å±‚è¿”å› Top-K ç»“æœ

å¤æ‚åº¦: O(log N) æœç´¢ï¼ŒO(N log N) æ„å»º
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
vector_recall/
â”‚
â”œâ”€â”€ ğŸ“„ README.md                 # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ requirements.txt          # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ ğŸ“„ main.py                   # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ ğŸ“„ config.py                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ trainer.py                # è®­ç»ƒå™¨
â”œâ”€â”€ ğŸ“„ recall_service.py         # å¬å›æœåŠ¡
â”‚
â”œâ”€â”€ ğŸ“ models/                   # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ encoders.py              # ç”¨æˆ·/ç‰©å“ç¼–ç å™¨
â”‚   â””â”€â”€ two_tower.py             # åŒå¡”æ¨¡å‹ & æŸå¤±å‡½æ•°
â”‚
â”œâ”€â”€ ğŸ“ index/                    # ç´¢å¼•æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ hnsw_index.py            # HNSWç´¢å¼•å°è£…
â”‚
â”œâ”€â”€ ğŸ“ data/                     # æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ dataset.py               # æ•°æ®é›† & æ•°æ®ç”Ÿæˆ
â”‚
â”œâ”€â”€ ğŸ“ checkpoints/              # æ¨¡å‹æ£€æŸ¥ç‚¹ (è‡ªåŠ¨ç”Ÿæˆ)
â”‚   â”œâ”€â”€ best_model.pt
â”‚   â””â”€â”€ checkpoint_epoch_*.pt
â”‚
â””â”€â”€ ğŸ“ index_files/              # ç´¢å¼•æ–‡ä»¶ (è‡ªåŠ¨ç”Ÿæˆ)
    â”œâ”€â”€ hnsw.bin
    â””â”€â”€ hnsw.meta
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `config.py` | æ¨¡å‹ã€è®­ç»ƒã€ç´¢å¼•çš„è¶…å‚æ•°é…ç½® |
| `models/encoders.py` | UserEncoder å’Œ ItemEncoder å®ç° |
| `models/two_tower.py` | åŒå¡”æ¨¡å‹å’Œå¯¹æ¯”å­¦ä¹ æŸå¤± |
| `index/hnsw_index.py` | HNSW ç´¢å¼•çš„å°è£…ï¼Œæ”¯æŒå¢é‡æ„å»ºå’ŒæŒä¹…åŒ– |
| `data/dataset.py` | PyTorch Datasetï¼Œæ”¯æŒè´Ÿé‡‡æ · |
| `trainer.py` | è®­ç»ƒå¾ªç¯ + ç´¢å¼•æ„å»ºå™¨ |
| `recall_service.py` | åœ¨çº¿å¬å›æœåŠ¡æ¥å£ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python >= 3.8
- PyTorch >= 2.0
- CUDA >= 11.0 (å¯é€‰ï¼Œç”¨äº GPU åŠ é€Ÿ)

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/vector-recall.git
cd vector-recall

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (æ¨è)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### requirements.txt

```
torch>=2.0.0
numpy>=1.24.0
hnswlib>=0.7.0
tqdm>=4.65.0
```

---

## ğŸ“‹ è¿è¡Œç¤ºä¾‹

### 1. å®Œæ•´è®­ç»ƒæµç¨‹

```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°è¿è¡Œ
python main.py

# è‡ªå®šä¹‰å‚æ•°è¿è¡Œ
python main.py \
    --num_users 50000 \
    --num_items 500000 \
    --num_interactions 2000000 \
    --embedding_dim 128 \
    --batch_size 2048 \
    --epochs 10 \
    --num_negatives 15 \
    --lr 0.001
```

### 2. å¿«é€Ÿæµ‹è¯•

```bash
# å°è§„æ¨¡å¿«é€Ÿæµ‹è¯• (é€‚åˆéªŒè¯ä»£ç )
python main.py \
    --num_users 1000 \
    --num_items 10000 \
    --num_interactions 50000 \
    --epochs 2 \
    --skip_benchmark
```

### 3. å‘½ä»¤è¡Œå‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--num_users` | 10000 | ç”¨æˆ·æ•°é‡ |
| `--num_items` | 100000 | ç‰©å“æ•°é‡ |
| `--num_interactions` | 500000 | äº¤äº’æ ·æœ¬æ•° |
| `--embedding_dim` | 128 | å‘é‡ç»´åº¦ |
| `--batch_size` | 1024 | æ‰¹å¤§å° |
| `--lr` | 0.001 | å­¦ä¹ ç‡ |
| `--epochs` | 5 | è®­ç»ƒè½®æ•° |
| `--num_negatives` | 10 | æ¯ä¸ªæ­£æ ·æœ¬çš„è´Ÿæ ·æœ¬æ•° |
| `--skip_benchmark` | False | è·³è¿‡æ€§èƒ½æµ‹è¯• |

---

## ğŸ“Š è¿è¡Œè¾“å‡ºç¤ºä¾‹

```
============================================================
Vector Recall System - Training
============================================================
Generating synthetic data...
Generated 500000 interactions
Model parameters: 2,534,912

Epoch 1: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 439/439 [00:42<00:00, 10.31it/s, loss=2.4521]
Epoch 1: train_loss=2.4521, val_loss=2.1876, lr=0.000950
Checkpoint saved to ./checkpoints/best_model.pt

Epoch 2: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 439/439 [00:41<00:00, 10.58it/s, loss=1.8234]
Epoch 2: train_loss=1.8234, val_loss=1.6543, lr=0.000800
Checkpoint saved to ./checkpoints/checkpoint_epoch_2.pt
Checkpoint saved to ./checkpoints/best_model.pt

...

Epoch 5: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 439/439 [00:40<00:00, 10.82it/s, loss=0.9876]
Epoch 5: train_loss=0.9876, val_loss=0.8765, lr=0.000100

Building HNSW index...
Encoding items: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 98/98 [00:08<00:00, 11.23it/s]
Index built in 12.45s, total items: 100000
Index saved to ./index/hnsw

============================================================
Performance Benchmark
============================================================

Single Query Latency (Top-500):
  Mean: 1.23 ms
  P50:  1.12 ms
  P95:  1.87 ms
  P99:  2.34 ms
  QPS:  813.0

Batch Query Throughput:
  Batch=16:  3.21ms, QPS=4984.4
  Batch=32:  5.43ms, QPS=5893.9
  Batch=64:  8.76ms, QPS=7306.0
  Batch=128: 14.32ms, QPS=8938.5

Index Statistics:
  dim: 128
  max_elements: 100000
  current_count: 100000
  M: 16
  ef_construction: 200
  ef_search: 100
  space: cosine

============================================================
Recall Demo
============================================================

Recalling for User 4567...
Latency: 1.15 ms

Top-20 Recommended Items:
----------------------------------------
Rank   Item ID      Score     
----------------------------------------
1      78234        0.9456
2      45123        0.9234
3      89012        0.9187
4      12456        0.9023
5      67890        0.8976
6      34567        0.8854
7      90123        0.8743
8      23456        0.8698
9      56789        0.8612
10     11234        0.8534
...
```

---

## ğŸ”§ API ä½¿ç”¨ç¤ºä¾‹

### è®­ç»ƒæ¨¡å‹

```python
from config import ModelConfig, TrainingConfig
from models.two_tower import TwoTowerModel
from trainer import Trainer
from torch.utils.data import DataLoader

# é…ç½®
model_config = ModelConfig(num_users=10000, num_items=100000)
train_config = TrainingConfig(batch_size=1024, num_epochs=10)

# åˆ›å»ºæ¨¡å‹
model = TwoTowerModel(model_config)

# è®­ç»ƒ
trainer = Trainer(model, train_loader, val_loader, train_config)
trainer.train()
```

### æ„å»ºç´¢å¼•

```python
from config import HNSWConfig
from trainer import IndexBuilder
import numpy as np

# é…ç½®
hnsw_config = HNSWConfig(dim=128, max_elements=100000)

# æ„å»ºç´¢å¼•
index_builder = IndexBuilder(model, hnsw_config)
index = index_builder.build_index(
    item_ids=np.arange(100000),
    item_categories=item_categories,
    item_tags=item_tags,
    item_features=item_features
)

# ä¿å­˜ç´¢å¼•
index.save('./index/hnsw')
```

### åœ¨çº¿å¬å›

```python
from recall_service import VectorRecallService

# åŠ è½½æœåŠ¡
service = VectorRecallService.from_files(
    model_path='./checkpoints/best_model.pt',
    index_path='./index/hnsw',
    model_config=model_config
)

# å•ç”¨æˆ·å¬å›
result = service.recall(
    user_id=1234,
    user_features=user_features[1234],
    top_k=500
)

print(f"å¬å› {len(result.item_ids)} ä¸ªç‰©å“")
print(f"å»¶è¿Ÿ: {result.latency_ms:.2f} ms")
print(f"Top-10 ç‰©å“: {result.item_ids[:10]}")
print(f"å¯¹åº”åˆ†æ•°: {result.scores[:10]}")

# æ‰¹é‡å¬å›
results = service.batch_recall(
    user_ids=np.array([1, 2, 3, 4, 5]),
    user_features=user_features[:5],
    top_k=500
)
```

---

## âš™ï¸ é…ç½®è°ƒä¼˜

### HNSW å‚æ•°è°ƒä¼˜

| å‚æ•° | è¯´æ˜ | è°ƒä¼˜å»ºè®® |
|------|------|----------|
| `M` | èŠ‚ç‚¹æœ€å¤§è¿æ¥æ•° | å¢å¤§æé«˜ç²¾åº¦ï¼Œä½†å¢åŠ å†…å­˜å’Œæ„å»ºæ—¶é—´ã€‚æ¨è 12-48 |
| `ef_construction` | æ„å»ºæ—¶æœç´¢å®½åº¦ | è¶Šå¤§ç²¾åº¦è¶Šé«˜ï¼Œæ„å»ºè¶Šæ…¢ã€‚æ¨è 100-500 |
| `ef_search` | æŸ¥è¯¢æ—¶æœç´¢å®½åº¦ | è¶Šå¤§ç²¾åº¦è¶Šé«˜ï¼ŒæŸ¥è¯¢è¶Šæ…¢ã€‚æ¨è 50-200 |

```python
# é«˜ç²¾åº¦é…ç½® (Recall@100 > 99%)
hnsw_config = HNSWConfig(
    M=32,
    ef_construction=400,
    ef_search=200
)

# ä½å»¶è¿Ÿé…ç½® (< 1ms)
hnsw_config = HNSWConfig(
    M=12,
    ef_construction=100,
    ef_search=50
)
```

### æ¨¡å‹å‚æ•°è°ƒä¼˜

| å‚æ•° | è¯´æ˜ | è°ƒä¼˜å»ºè®® |
|------|------|----------|
| `embedding_dim` | å‘é‡ç»´åº¦ | 64-256ï¼Œè¶Šå¤§è¡¨è¾¾èƒ½åŠ›è¶Šå¼ºä½†è®¡ç®—è¶Šæ…¢ |
| `num_negatives` | è´Ÿæ ·æœ¬æ•° | 10-50ï¼Œè¶Šå¤šè®­ç»ƒè¶Šç¨³å®šä½†è¶Šæ…¢ |
| `temperature` | å¯¹æ¯”å­¦ä¹ æ¸©åº¦ | 0.05-0.2ï¼Œè¶Šå°åˆ†å¸ƒè¶Šå°–é” |

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è®­ç»ƒä¼˜åŒ–

```python
# ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
from torch.cuda.amp import autocast, GradScaler

scaler = GradScaler()

with autocast():
    output = model(user_data, pos_item_data, neg_item_data)
    loss = criterion(output)

scaler.scale(loss).backward()
scaler.step(optimizer)
scaler.update()
```

### 2. ç´¢å¼•ä¼˜åŒ–

```python
# ä½¿ç”¨å†…ç§¯ä»£æ›¿ä½™å¼¦è·ç¦»ï¼ˆå‘é‡å·²å½’ä¸€åŒ–æ—¶ç­‰ä»·ï¼Œä½†æ›´å¿«ï¼‰
hnsw_config = HNSWConfig(space='ip')

# å¢åŠ æ„å»ºçº¿ç¨‹
index = HNSWIndex(..., num_threads=16)
```

### 3. æœåŠ¡ä¼˜åŒ–

```python
# é¢„çƒ­æ¨¡å‹ï¼ˆé¿å…é¦–æ¬¡æŸ¥è¯¢å»¶è¿Ÿï¼‰
for _ in range(100):
    _ = service.recall(0, dummy_features, top_k=100)

# ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢æé«˜åå
results = service.batch_recall(user_ids, user_features, top_k=500)
```

---

## ğŸ”„ ç”Ÿäº§éƒ¨ç½²

### Docker éƒ¨ç½²

```dockerfile
FROM pytorch/pytorch:2.0.0-cuda11.7-cudnn8-runtime

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# é¢„åŠ è½½æ¨¡å‹å’Œç´¢å¼•
ENV MODEL_PATH=/app/checkpoints/best_model.pt
ENV INDEX_PATH=/app/index/hnsw

CMD ["python", "serve.py"]
```

### Kubernetes é…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vector-recall-service
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: recall-service
        image: vector-recall:latest
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
            nvidia.com/gpu: 1
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [HNSW Paper](https://arxiv.org/abs/1603.09320) - Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs
- [Two-Tower Model](https://dl.acm.org/doi/10.1145/3366423.3380130) - Sampling-Bias-Corrected Neural Modeling for Large Corpus Item Recommendations
- [InfoNCE Loss](https://arxiv.org/abs/1807.03748) - Representation Learning with Contrastive Predictive Coding

---

## ğŸ“„ License

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

<p align="center">
  <b>Happy Recommending! ğŸ¯</b>
</p>
