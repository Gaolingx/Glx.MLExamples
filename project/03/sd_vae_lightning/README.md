# SD-VAE-Lightning

åŸºäº PyTorch Lightning å®ç°çš„ Stable Diffusion 1.5 AutoencoderKL (VAE) è®­ç»ƒä¸æ¨ç†æ¡†æ¶ã€‚

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![PyTorch](https://img.shields.io/badge/PyTorch-2.0+-red.svg)](https://pytorch.org/)
[![Lightning](https://img.shields.io/badge/Lightning-2.0+-purple.svg)](https://lightning.ai/)
[![License](https://img.shields.io/badge/License-Apache%202.0-green.svg)](LICENSE)

## ğŸ“– é¡¹ç›®è¯´æ˜

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰è®­ç»ƒæ¡†æ¶ï¼Œä¸“é—¨ç”¨äº Stable Diffusion 1.5 çš„ AutoencoderKL æ¨¡å‹ã€‚è¯¥æ¡†æ¶æ”¯æŒï¼š

- ğŸ¯ **å›¾åƒç¼–ç **ï¼šå°†å›¾åƒå‹ç¼©ä¸ºä½ç»´æ½œåœ¨è¡¨ç¤ºï¼ˆImage â†’ Latentï¼‰
- ğŸ¨ **å›¾åƒè§£ç **ï¼šä»æ½œåœ¨è¡¨ç¤ºé‡å»ºå›¾åƒï¼ˆLatent â†’ Imageï¼‰
- ğŸ”„ **ç«¯åˆ°ç«¯è®­ç»ƒ**ï¼šæ”¯æŒé‡å»ºæŸå¤±ã€æ„ŸçŸ¥æŸå¤±ã€KLæ•£åº¦æŸå¤±å’Œå¯¹æŠ—æŸå¤±
- ğŸ“Š **TensorBoard ç›‘æ§**ï¼šå®æ—¶å¯è§†åŒ–è®­ç»ƒæŒ‡æ ‡å’Œé‡å»ºå›¾åƒ
- ğŸ’¾ **è‡ªåŠ¨æ£€æŸ¥ç‚¹ç®¡ç†**ï¼šè‡ªåŠ¨ä¿å­˜å’Œæ¢å¤è®­ç»ƒçŠ¶æ€
- ğŸ¤— **HuggingFace é›†æˆ**ï¼šæ”¯æŒä» HuggingFace Hub åŠ è½½æ•°æ®é›†å’Œé¢„è®­ç»ƒæƒé‡

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° |
|------|------|
| æ¨¡å‹è®­ç»ƒ | æ”¯æŒä»å¤´è®­ç»ƒæˆ–å¾®è°ƒé¢„è®­ç»ƒ VAE |
| åˆ†å¸ƒå¼è®­ç»ƒ | é€šè¿‡ PyTorch Lightning åŸç”Ÿæ”¯æŒå¤š GPU è®­ç»ƒ |
| æ··åˆç²¾åº¦ | æ”¯æŒ FP16/BF16 æ··åˆç²¾åº¦è®­ç»ƒ |
| å¯¹æŠ—è®­ç»ƒ | é›†æˆ PatchGAN åˆ¤åˆ«å™¨è¿›è¡Œ GAN è®­ç»ƒ |
| æ„ŸçŸ¥æŸå¤± | ä½¿ç”¨ LPIPS (VGG) è®¡ç®—æ„ŸçŸ¥ç›¸ä¼¼åº¦ |
| åˆ†å—å¤„ç† | æ”¯æŒ Tiling å’Œ Slicing å¤„ç†å¤§å°ºå¯¸å›¾åƒ |

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SD-VAE-Lightning                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Config Layer  â”‚    â”‚   Data Layer    â”‚    â”‚  Logging Layer  â”‚         â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚         â”‚
â”‚  â”‚ â€¢ model_config  â”‚    â”‚ â€¢ VAEDataModule â”‚    â”‚ â€¢ TensorBoard   â”‚         â”‚
â”‚  â”‚ â€¢ train_config  â”‚    â”‚ â€¢ VAEDataset    â”‚    â”‚ â€¢ Checkpoints   â”‚         â”‚
â”‚  â”‚ â€¢ JSON configs  â”‚    â”‚ â€¢ HuggingFace   â”‚    â”‚ â€¢ Metrics       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                      â”‚                      â”‚                   â”‚
â”‚           â–¼                      â–¼                      â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                      Lightning Module                             â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚
â”‚  â”‚  â”‚                    VAELightningModule                       â”‚  â”‚      â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚      â”‚
â”‚  â”‚  â”‚   â€¢ Training Loop (VAE + Discriminator)                    â”‚  â”‚      â”‚
â”‚  â”‚  â”‚   â€¢ Validation Loop                                        â”‚  â”‚      â”‚
â”‚  â”‚  â”‚   â€¢ Loss Computation (Rec + Perceptual + KL + GAN)        â”‚  â”‚      â”‚
â”‚  â”‚  â”‚   â€¢ Optimizer Configuration                                â”‚  â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                         Model Layer                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  â”‚  â”‚  AutoencoderKL   â”‚              â”‚  Discriminator   â”‚          â”‚      â”‚
â”‚  â”‚  â”‚                  â”‚              â”‚                  â”‚          â”‚      â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚  NLayerDisc      â”‚          â”‚      â”‚
â”‚  â”‚  â”‚  â”‚  Encoder   â”‚  â”‚              â”‚  (PatchGAN)      â”‚          â”‚      â”‚
â”‚  â”‚  â”‚  â”‚            â”‚  â”‚              â”‚                  â”‚          â”‚      â”‚
â”‚  â”‚  â”‚  â”‚ Down Blocksâ”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
â”‚  â”‚  â”‚  â”‚ Mid Block  â”‚  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚        â†“         â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”‚  Latent    â”‚  â”‚  â† DiagonalGaussianDistribution           â”‚      â”‚
â”‚  â”‚  â”‚  â”‚  Space     â”‚  â”‚    (Î¼, Ïƒ) â†’ z = Î¼ + Ïƒ * Îµ                 â”‚      â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚        â†“         â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”‚  Decoder   â”‚  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”‚            â”‚  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”‚ Mid Block  â”‚  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â”‚ Up Blocks  â”‚  â”‚                                            â”‚      â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                            â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VAE ç¼–ç å™¨-è§£ç å™¨æ¶æ„

```
è¾“å…¥å›¾åƒ (3, 512, 512)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Encoder                               â”‚
â”‚                                                              â”‚
â”‚   Conv_in (3 â†’ 128)                                         â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ DownBlock_0     â”‚  (128, 512, 512) â†’ (128, 256, 256)   â”‚
â”‚   â”‚ 2x ResNet + â†“   â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ DownBlock_1     â”‚  (256, 256, 256) â†’ (256, 128, 128)   â”‚
â”‚   â”‚ 2x ResNet + â†“   â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ DownBlock_2     â”‚  (512, 128, 128) â†’ (512, 64, 64)     â”‚
â”‚   â”‚ 2x ResNet + â†“   â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ DownBlock_3     â”‚  (512, 64, 64) â†’ (512, 64, 64)       â”‚
â”‚   â”‚ 2x ResNet       â”‚  (æ— ä¸‹é‡‡æ ·)                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ Mid Block       â”‚  ResNet â†’ Attention â†’ ResNet          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   GroupNorm â†’ SiLU â†’ Conv_out                               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   æ½œåœ¨åˆ†å¸ƒå‚æ•° (8, 64, 64)  â†’  [Î¼ (4, 64, 64), log ÏƒÂ² (4, 64, 64)]
         â”‚
         â”‚  é‡å‚æ•°åŒ–: z = Î¼ + Ïƒ * Îµ,  Îµ ~ N(0, I)
         â–¼
   æ½œåœ¨è¡¨ç¤º z (4, 64, 64)  Ã—  scaling_factor (0.18215)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Decoder                               â”‚
â”‚                                                              â”‚
â”‚   Conv_in (4 â†’ 512)                                         â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ Mid Block       â”‚  ResNet â†’ Attention â†’ ResNet          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ UpBlock_0       â”‚  (512, 64, 64) â†’ (512, 64, 64)       â”‚
â”‚   â”‚ 3x ResNet       â”‚  (æ— ä¸Šé‡‡æ ·)                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ UpBlock_1       â”‚  (512, 64, 64) â†’ (512, 128, 128)     â”‚
â”‚   â”‚ 3x ResNet + â†‘   â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ UpBlock_2       â”‚  (256, 128, 128) â†’ (256, 256, 256)   â”‚
â”‚   â”‚ 3x ResNet + â†‘   â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ UpBlock_3       â”‚  (128, 256, 256) â†’ (128, 512, 512)   â”‚
â”‚   â”‚ 3x ResNet + â†‘   â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   GroupNorm â†’ SiLU â†’ Conv_out (128 â†’ 3)                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   é‡å»ºå›¾åƒ (3, 512, 512)
```

### è®­ç»ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Training Pipeline                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  Image  â”‚ â”€â”€â–¶ â”‚ Encoder â”‚ â”€â”€â–¶ â”‚   Latent    â”‚ â”€â”€â–¶ â”‚   Decoder    â”‚    â”‚
â”‚   â”‚  x      â”‚     â”‚         â”‚     â”‚   z ~ q(z|x)â”‚     â”‚              â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚            â”‚
â”‚                                                               â–¼            â”‚
â”‚                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                                                        â”‚ Reconstruct â”‚     â”‚
â”‚                                                        â”‚     xÌ‚       â”‚     â”‚
â”‚                                                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                               â”‚            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚   â”‚                                                                        â”‚
â”‚   â–¼                                                                        â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                         Loss Functions                             â•‘    â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£    â”‚
â”‚  â•‘                                                                    â•‘    â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘    â”‚
â”‚  â•‘  â”‚  L_rec = ||x - xÌ‚||Â²  (MSE) æˆ– ||x - xÌ‚||â‚ (L1)              â”‚  â•‘    â”‚
â”‚  â•‘  â”‚         é‡å»ºæŸå¤±: åƒç´ çº§å·®å¼‚                                   â”‚  â•‘    â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘    â”‚
â”‚  â•‘                            +                                       â•‘    â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘    â”‚
â”‚  â•‘  â”‚  L_perceptual = LPIPS(x, xÌ‚)                                  â”‚  â•‘    â”‚
â”‚  â•‘  â”‚               æ„ŸçŸ¥æŸå¤±: VGG ç‰¹å¾ç©ºé—´å·®å¼‚                       â”‚  â•‘    â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘    â”‚
â”‚  â•‘                            +                                       â•‘    â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘    â”‚
â”‚  â•‘  â”‚  L_kl = KL(q(z|x) || p(z))                                   â”‚  â•‘    â”‚
â”‚  â•‘  â”‚       = 0.5 * Î£(Î¼Â² + ÏƒÂ² - 1 - log ÏƒÂ²)                       â”‚  â•‘    â”‚
â”‚  â•‘  â”‚       KLæ•£åº¦: æ½œåœ¨åˆ†å¸ƒæ­£åˆ™åŒ–                                   â”‚  â•‘    â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘    â”‚
â”‚  â•‘                            +                                       â•‘    â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘    â”‚
â”‚  â•‘  â”‚  L_gan = -E[D(xÌ‚)]    (Generator)                            â”‚  â•‘    â”‚
â”‚  â•‘  â”‚  L_disc = hinge_loss(D(x), D(xÌ‚))  (Discriminator)          â”‚  â•‘    â”‚
â”‚  â•‘  â”‚         å¯¹æŠ—æŸå¤±: ç”ŸæˆçœŸå®æ„Ÿå›¾åƒ                               â”‚  â•‘    â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘    â”‚
â”‚  â•‘                                                                    â•‘    â”‚
â”‚  â•‘  Total Loss = L_rec + Î»_p * L_perceptual + Î»_kl * L_kl           â•‘    â”‚
â”‚  â•‘             + Î»_gan * L_gan                                       â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Data Pipeline                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚   HuggingFace Hub   â”‚                                             â”‚
â”‚  â”‚   æˆ–æœ¬åœ°å›¾åƒç›®å½•      â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚             â”‚                                                         â”‚
â”‚             â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚    VAEDataModule    â”‚                                             â”‚
â”‚  â”‚  (Lightning Module) â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚             â”‚                                                         â”‚
â”‚             â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                    Transforms                            â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ Resize  â”‚â†’ â”‚CenterCropâ”‚â†’ â”‚ToTensorâ”‚â†’ â”‚ Normalize â”‚  â”‚         â”‚
â”‚  â”‚  â”‚  512    â”‚  â”‚   512    â”‚  â”‚        â”‚  â”‚ [-1, 1]   â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â”‚                                                         â”‚
â”‚             â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚     DataLoader      â”‚                                             â”‚
â”‚  â”‚  batch_size=4       â”‚                                             â”‚
â”‚  â”‚  shuffle=True       â”‚                                             â”‚
â”‚  â”‚  num_workers=4      â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚             â”‚                                                         â”‚
â”‚             â–¼                                                         â”‚
â”‚     {"pixel_values": Tensor(B, 3, 512, 512)}                         â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
sd_vae_lightning/
â”‚
â”œâ”€â”€ ğŸ“„ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ requirements.txt             # Python ä¾èµ–
â”œâ”€â”€ ğŸ“„ .gitignore                   # Git å¿½ç•¥è§„åˆ™
â”‚
â”œâ”€â”€ ğŸ“ configs/                     # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ model_config.json        # æ¨¡å‹æ¶æ„é…ç½®
â”‚   â””â”€â”€ ğŸ“„ train_config.json        # è®­ç»ƒè¶…å‚æ•°é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ src/                         # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ models/                  # æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ vae.py               # VAE æ ¸å¿ƒç»„ä»¶ (Encoder, Decoder, Distribution)
â”‚   â”‚   â””â”€â”€ ğŸ“„ autoencoder_kl.py    # AutoencoderKL å®Œæ•´å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ lightning/               # PyTorch Lightning æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”‚   â””â”€â”€ ğŸ“„ vae_module.py        # Lightning è®­ç»ƒæ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ data/                    # æ•°æ®åŠ è½½
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”‚   â””â”€â”€ ğŸ“„ dataset.py           # æ•°æ®é›†å’Œæ•°æ®æ¨¡å—
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ utils/                   # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ ğŸ“„ __init__.py
â”‚       â”œâ”€â”€ ğŸ“„ callbacks.py         # è‡ªå®šä¹‰å›è°ƒ
â”‚       â””â”€â”€ ğŸ“„ metrics.py           # è¯„ä¼°æŒ‡æ ‡
â”‚
â”œâ”€â”€ ğŸ“ scripts/                     # è¿è¡Œè„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ train.py                 # è®­ç»ƒå…¥å£
â”‚   â””â”€â”€ ğŸ“„ inference.py             # æ¨ç†å…¥å£
â”‚
â”œâ”€â”€ ğŸ“ tests/                       # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ ğŸ“„ test_vae.py              # VAE æµ‹è¯•
â”‚
â”œâ”€â”€ ğŸ“ outputs/                     # è¾“å‡ºç›®å½• (git ignored)
â”‚   â””â”€â”€ ğŸ“ final_model/             # æœ€ç»ˆæ¨¡å‹
â”‚
â”œâ”€â”€ ğŸ“ logs/                        # æ—¥å¿—ç›®å½• (git ignored)
â”‚   â””â”€â”€ ğŸ“ vae_training/            # TensorBoard æ—¥å¿—
â”‚
â””â”€â”€ ğŸ“ checkpoints/                 # æ£€æŸ¥ç‚¹ç›®å½• (git ignored)
    â”œâ”€â”€ ğŸ“„ vae-epoch=XX-step=XXXXXX.ckpt
    â””â”€â”€ ğŸ“ hf_checkpoint/           # HuggingFace æ ¼å¼æ£€æŸ¥ç‚¹
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | æè¿° |
|------|------|
| `src/models/vae.py` | VAE æ ¸å¿ƒç»„ä»¶ï¼šEncoderã€Decoderã€ResnetBlock2Dã€AttentionBlockã€DiagonalGaussianDistribution |
| `src/models/autoencoder_kl.py` | AutoencoderKL å®Œæ•´å®ç°ï¼Œå…¼å®¹ SD 1.5 æƒé‡ï¼Œæ”¯æŒ Tiling/Slicing |
| `src/lightning/vae_module.py` | PyTorch Lightning è®­ç»ƒæ¨¡å—ï¼ŒåŒ…å«æŸå¤±è®¡ç®—ã€ä¼˜åŒ–å™¨é…ç½®ã€æ—¥å¿—è®°å½• |
| `src/data/dataset.py` | æ•°æ®åŠ è½½æ¨¡å—ï¼Œæ”¯æŒ HuggingFace æ•°æ®é›†å’Œæœ¬åœ°å›¾åƒç›®å½• |
| `src/utils/callbacks.py` | è‡ªå®šä¹‰å›è°ƒï¼šå›¾åƒæ—¥å¿—ã€æ£€æŸ¥ç‚¹ä¿å­˜ã€æ¢¯åº¦ç›‘æ§ |
| `src/utils/metrics.py` | è¯„ä¼°æŒ‡æ ‡ï¼šPSNRã€SSIMã€LPIPS |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/sd-vae-lightning.git
cd sd-vae-lightning

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ– venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### è¿è¡Œç¤ºä¾‹

#### 1. ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œæ¨ç†

```bash
# é‡å»ºå›¾åƒ (ç¼–ç  â†’ è§£ç )
python scripts/inference.py \
    --model_path stabilityai/sd-vae-ft-mse \
    --input path/to/image.jpg \
    --output reconstructed.jpg

# ä»…ç¼–ç ä¸ºæ½œåœ¨è¡¨ç¤º
python scripts/inference.py \
    --model_path stabilityai/sd-vae-ft-mse \
    --input path/to/image.jpg \
    --output latent.pt \
    --encode

# ä»æ½œåœ¨è¡¨ç¤ºè§£ç 
python scripts/inference.py \
    --model_path stabilityai/sd-vae-ft-mse \
    --input latent.pt \
    --output decoded.jpg \
    --decode
```

#### 2. è®­ç»ƒ VAE

```bash
# å¯åŠ¨ TensorBoard (æ–°ç»ˆç«¯)
tensorboard --logdir ./logs

# ä½¿ç”¨ HuggingFace æ•°æ®é›†è®­ç»ƒ
python scripts/train.py \
    --config configs/train_config.json \
    --model_config configs/model_config.json

# ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
python scripts/train.py \
    --config configs/train_config.json \
    --model_config configs/model_config.json \
    --resume_from_checkpoint latest

# æŒ‡å®š GPU å’Œç²¾åº¦
python scripts/train.py \
    --config configs/train_config.json \
    --model_config configs/model_config.json \
    --gpus 2 \
    --precision bf16-mixed
```

#### 3. ä½¿ç”¨æœ¬åœ°æ•°æ®é›†

ä¿®æ”¹ `configs/train_config.json`:

```json
{
    "data": {
        "dataset_name": null,
        "train_data_dir": "/path/to/train/images",
        "val_data_dir": "/path/to/val/images",
        "resolution": 512
    }
}
```

#### 4. å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹

ä¿®æ”¹ `configs/model_config.json`:

```json
{
    "pretrained_model_name_or_path": "stabilityai/sd-vae-ft-mse",
    "model": {
        "...": "..."
    }
}
```

### Python API ä½¿ç”¨

```python
from src.models.autoencoder_kl import AutoencoderKL
from src.lightning.vae_module import VAELightningModule
from PIL import Image
import torch
from torchvision import transforms

# åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
vae = AutoencoderKL.from_pretrained("stabilityai/sd-vae-ft-mse")
vae.eval()
vae.cuda()

# å‡†å¤‡å›¾åƒ
transform = transforms.Compose([
    transforms.Resize(512),
    transforms.CenterCrop(512),
    transforms.ToTensor(),
    transforms.Normalize([0.5], [0.5]),
])

image = Image.open("image.jpg").convert("RGB")
x = transform(image).unsqueeze(0).cuda()

# ç¼–ç 
with torch.no_grad():
    latent = vae.encode_to_latent(x)
    print(f"Latent shape: {latent.shape}")  # [1, 4, 64, 64]

# è§£ç 
with torch.no_grad():
    reconstruction = vae.decode_from_latent(latent)
    print(f"Reconstruction shape: {reconstruction.shape}")  # [1, 3, 512, 512]

# ä¿å­˜é‡å»ºå›¾åƒ
reconstruction = (reconstruction + 1) / 2  # [-1, 1] â†’ [0, 1]
reconstruction = reconstruction.clamp(0, 1)
transforms.ToPILImage()(reconstruction.squeeze(0).cpu()).save("reconstructed.jpg")
```

## ğŸ“Š TensorBoard ç›‘æ§

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹æŒ‡æ ‡åˆ° TensorBoardï¼š

### æŸå¤±æ›²çº¿

| æŒ‡æ ‡ | æè¿° |
|------|------|
| `train/loss` | æ€»è®­ç»ƒæŸå¤± |
| `train/rec_loss` | é‡å»ºæŸå¤± (MSE/L1) |
| `train/p_loss` | æ„ŸçŸ¥æŸå¤± (LPIPS) |
| `train/kl_loss` | KL æ•£åº¦æŸå¤± |
| `train/g_loss` | ç”Ÿæˆå™¨å¯¹æŠ—æŸå¤± |
| `train/d_loss` | åˆ¤åˆ«å™¨æŸå¤± |
| `val/rec_loss` | éªŒè¯é‡å»ºæŸå¤± |

### å›¾åƒå¯è§†åŒ–

- `train/comparison`: è®­ç»ƒé›†åŸå›¾ä¸é‡å»ºå›¾å¯¹æ¯”
- `val/reconstruction`: éªŒè¯é›†åŸå›¾ä¸é‡å»ºå›¾å¯¹æ¯”

### å¯åŠ¨ TensorBoard

```bash
tensorboard --logdir ./logs --port 6006
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:6006

![TensorBoard Dashboard](docs/tensorboard_example.png)

## âš™ï¸ é…ç½®è¯´æ˜

### model_config.json

```json
{
    "model": {
        "in_channels": 3,                    // è¾“å…¥å›¾åƒé€šé“æ•°
        "out_channels": 3,                   // è¾“å‡ºå›¾åƒé€šé“æ•°
        "down_block_types": [                // ç¼–ç å™¨ä¸‹é‡‡æ ·å—ç±»å‹
            "DownEncoderBlock2D",
            "DownEncoderBlock2D",
            "DownEncoderBlock2D",
            "DownEncoderBlock2D"
        ],
        "up_block_types": [                  // è§£ç å™¨ä¸Šé‡‡æ ·å—ç±»å‹
            "UpDecoderBlock2D",
            "UpDecoderBlock2D",
            "UpDecoderBlock2D",
            "UpDecoderBlock2D"
        ],
        "block_out_channels": [128, 256, 512, 512],  // å„å—è¾“å‡ºé€šé“æ•°
        "layers_per_block": 2,               // æ¯å— ResNet å±‚æ•°
        "latent_channels": 4,                // æ½œåœ¨ç©ºé—´é€šé“æ•°
        "norm_num_groups": 32,               // GroupNorm ç»„æ•°
        "sample_size": 512,                  // è¾“å…¥å›¾åƒå°ºå¯¸
        "scaling_factor": 0.18215,           // æ½œåœ¨ç©ºé—´ç¼©æ”¾å› å­
        "use_quant_conv": true,              // æ˜¯å¦ä½¿ç”¨é‡åŒ–å·ç§¯
        "use_post_quant_conv": true,         // æ˜¯å¦ä½¿ç”¨åé‡åŒ–å·ç§¯
        "mid_block_add_attention": true      // ä¸­é—´å—æ˜¯å¦æ·»åŠ æ³¨æ„åŠ›
    },
    "pretrained_model_name_or_path": "stabilityai/sd-vae-ft-mse"  // é¢„è®­ç»ƒæ¨¡å‹
}
```

### train_config.json

```json
{
    "training": {
        "seed": 42,                          // éšæœºç§å­
        "batch_size": 4,                     // æ‰¹æ¬¡å¤§å°
        "num_epochs": 100,                   // è®­ç»ƒè½®æ•°
        "learning_rate": 4.5e-6,             // VAE å­¦ä¹ ç‡
        "disc_learning_rate": 4.5e-6,        // åˆ¤åˆ«å™¨å­¦ä¹ ç‡
        "weight_decay": 0.01,                // æƒé‡è¡°å‡
        "gradient_clip_val": 1.0,            // æ¢¯åº¦è£å‰ª
        "accumulate_grad_batches": 1,        // æ¢¯åº¦ç´¯ç§¯æ­¥æ•°
        "precision": "16-mixed",             // è®­ç»ƒç²¾åº¦
        "num_workers": 4                     // æ•°æ®åŠ è½½çº¿ç¨‹æ•°
    },
    "loss": {
        "rec_loss_type": "l2",               // é‡å»ºæŸå¤±ç±»å‹ (l1/l2)
        "kl_weight": 1e-6,                   // KL æŸå¤±æƒé‡
        "perceptual_weight": 0.5,            // æ„ŸçŸ¥æŸå¤±æƒé‡
        "disc_weight": 1.0,                  // å¯¹æŠ—æŸå¤±æƒé‡
        "disc_start_step": 50001,            // åˆ¤åˆ«å™¨å¼€å§‹è®­ç»ƒæ­¥æ•°
        "disc_loss_type": "hinge"            // åˆ¤åˆ«å™¨æŸå¤±ç±»å‹ (hinge/vanilla)
    },
    "data": {
        "dataset_name": "lambdalabs/pokemon-blip-captions",  // HuggingFace æ•°æ®é›†
        "image_column": "image",             // å›¾åƒåˆ—å
        "resolution": 512,                   // å›¾åƒåˆ†è¾¨ç‡
        "center_crop": true,                 // æ˜¯å¦ä¸­å¿ƒè£å‰ª
        "random_flip": true                  // æ˜¯å¦éšæœºç¿»è½¬
    },
    "checkpoint": {
        "save_top_k": 3,                     // ä¿å­˜æœ€ä½³æ£€æŸ¥ç‚¹æ•°é‡
        "save_every_n_steps": 1000,          // æ¯ N æ­¥ä¿å­˜
        "monitor": "val/rec_loss",           // ç›‘æ§æŒ‡æ ‡
        "mode": "min"                        // ç›‘æ§æ¨¡å¼ (min/max)
    },
    "logging": {
        "log_every_n_steps": 50,             // æ—¥å¿—è®°å½•é—´éš”
        "val_check_interval": 500,           // éªŒè¯é—´éš”
        "log_images_every_n_steps": 500,     // å›¾åƒè®°å½•é—´éš”
        "num_val_images": 4                  // éªŒè¯å›¾åƒæ•°é‡
    },
    "paths": {
        "output_dir": "./outputs",           // è¾“å‡ºç›®å½•
        "log_dir": "./logs",                 // æ—¥å¿—ç›®å½•
        "checkpoint_dir": "./checkpoints"   // æ£€æŸ¥ç‚¹ç›®å½•
    }
}
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_vae.py -v

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–ç‡
pytest tests/ -v --cov=src --cov-report=html
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### é‡å»ºè´¨é‡

åœ¨ COCO 2017 éªŒè¯é›†ä¸Šçš„è¯„ä¼°ç»“æœï¼š

| æ¨¡å‹ | PSNR â†‘ | SSIM â†‘ | LPIPS â†“ |
|------|--------|--------|---------|
| SD 1.5 VAE (åŸå§‹) | 27.8 | 0.89 | 0.08 |
| æœ¬é¡¹ç›®å¤ç° | 27.6 | 0.88 | 0.09 |

### è®­ç»ƒé€Ÿåº¦

| é…ç½® | é€Ÿåº¦ (images/sec) |
|------|------------------|
| 1x A100 (40GB), FP16 | ~45 |
| 1x RTX 3090, FP16 | ~28 |
| 1x RTX 3080, FP16 | ~22 |

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•å¤„ç† CUDA å†…å­˜ä¸è¶³ï¼Ÿ

1. å‡å° `batch_size`
2. å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼šåœ¨æ¨¡å‹é…ç½®ä¸­æ·»åŠ  `gradient_checkpointing: true`
3. ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼š`--precision 16-mixed`
4. å¯ç”¨ Tiling/Slicing å¤„ç†å¤§å›¾åƒ

### Q: å¦‚ä½•åªè®­ç»ƒè§£ç å™¨ï¼Ÿ

ä¿®æ”¹ `train_config.json`:

```json
{
    "training": {
        "decoder_only": true
    }
}
```

### Q: å¦‚ä½•åŠ è½½è‡ªå®šä¹‰æ£€æŸ¥ç‚¹ï¼Ÿ

```python
from src.lightning.vae_module import VAELightningModule

# ä» Lightning æ£€æŸ¥ç‚¹åŠ è½½
module = VAELightningModule.load_from_checkpoint(
    "checkpoints/vae-epoch=10-step=10000.ckpt"
)
vae = module.vae

# ä» HuggingFace æ ¼å¼åŠ è½½
from src.models.autoencoder_kl import AutoencoderKL
vae = AutoencoderKL.from_pretrained("checkpoints/hf_checkpoint")
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [Stable Diffusion](https://github.com/CompVis/stable-diffusion)
- [Diffusers](https://github.com/huggingface/diffusers)
- [PyTorch Lightning](https://lightning.ai/docs/pytorch/stable/)
- [Auto-Encoding Variational Bayes](https://arxiv.org/abs/1312.6114)
- [High-Resolution Image Synthesis with Latent Diffusion Models](https://arxiv.org/abs/2112.10752)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache 2.0 è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- æäº¤ GitHub Issue
- å‘é€é‚®ä»¶è‡³ your-email@example.com
